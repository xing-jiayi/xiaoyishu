# 定义流水线阶段
stages:
  - sync

# 定义同步任务
sync-to-github:
  stage: sync
  # 指定Runner标签
  tags:
    - sync
  # 使用轻量git镜像
  image: ruby:3.3
  # 每个job内部定义触发规则
  rules:
    - if: '$CI_PIPELINE_SOURCE == "push" && $CI_COMMIT_TAG == null'
      when: on_success
    - when: never
  script:
    # 提取提交者姓名和邮箱
    - git config --global user.name "$(echo $CI_COMMIT_AUTHOR | cut -d'<' -f1 | xargs)"
    - git config --global user.email "$(echo $CI_COMMIT_AUTHOR | cut -d'<' -f2 | cut -d'>' -f1 | xargs)"
    - git config --global http.sslVerify false

    # 克隆镜像仓库
    - git clone --mirror $CI_REPOSITORY_URL .git-mirror
    - cd .git-mirror

    # 构造带PAT的GitHub推送地址
    - GITHUB_PUSH_URL=$(echo $GITHUB_REPO_URL | sed "s/https:\/\//https:\/\/$GITHUB_PAT@/")

    # 推送至GitHub
    - git remote add github $GITHUB_PUSH_URL
    - git push --mirror github
  cache:
    paths:
      - .git-mirror/
  retry:
    max: 2
    when:
      - runner_system_failure
      - stuck_or_timeout_failure
      - api_failure